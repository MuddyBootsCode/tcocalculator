<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Development TCO Calculator - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Original variable section styles */
        .variables-section {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .variables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .variable-group {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
        }
        .variable-group h4 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .input-row label {
            font-size: 14px;
            color: #555;
        }
        .input-row input, .input-row select {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }
        .input-row select {
            width: auto;
            text-align: left;
        }
        .slider-control {
            margin-bottom: 15px;
        }
        .slider-control label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .slider-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .slider-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider-control input[type="range"]:hover::-webkit-slider-thumb {
            background: #1976D2;
            transform: scale(1.1);
        }
        .slider-control input[type="range"]:hover::-moz-range-thumb {
            background: #1976D2;
            transform: scale(1.1);
        }
        .slider-control span {
            font-weight: bold;
            color: #1976D2;
        }
        
        /* Chart Grid Layouts */
        .chart-grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .chart-grid-1x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #1976D2;
            font-size: 1.2em;
            text-align: center;
            font-weight: 600;
        }
        
        .chart-box {
            position: relative;
            height: 300px;
        }
        
        .chart-box.tall {
            height: 400px;
        }
        
        canvas {
            max-height: 100%;
        }
        
        h1 { color: #1976D2; text-align: center; margin-bottom: 30px; }
        h2 { color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 5px; }
        
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .summary-amount {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-item h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .summary-item .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; color: #333; }
        .number { text-align: right; font-family: 'Courier New', monospace; }
        .total-row { background-color: #fff3cd; font-weight: bold; }
        .section-header { background-color: #2196F3; color: white; }
        .currency { color: #2e7d32; }
        .positive { color: #2e7d32; }
        .negative { color: #d32f2f; }
        .user-cost-analysis {
            margin: 30px 0;
        }
        .user-cost-analysis table {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Software Development TCO Calculator - Enhanced</h1>
        
        <div class="summary-box">
            <h2 style="margin: 0; border: none; color: white;">üí∞ 3-Year Total Cost of Ownership</h2>
            <div class="summary-amount" id="totalTCO">$0</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>üìä 3 YearCost Per User</h3>
                    <div class="value" id="costPerUser">$0</div>
                </div>
                <div class="summary-item">
                    <h3>üìÖ Monthly Cost Per User</h3>
                    <div class="value" id="monthlyCostPerUser">$0</div>
                </div>
            </div>
        </div>

        <!-- Complete Interactive Controls Section (restored from original) -->
        <div class="variables-section">
            <h2>üéõÔ∏è Interactive Visualization Controls</h2>
            <div class="variables-grid">
                <div class="variable-group">
                    <h4>üìà Growth & Scale Controls</h4>
                    <div class="slider-control">
                        <label>Annual User Growth Rate: <span id="userGrowthValue">10</span>%</label>
                        <input type="range" id="userGrowthSlider" min="10" max="200" value="10" oninput="updateSliderValue('userGrowthSlider', 'userGrowthValue'); updateFromSlider('userGrowth', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Expected Users: <span id="expectedUsersValue">20,000</span></label>
                        <input type="range" id="expectedUsersSlider" min="100" max="100000" value="20000" oninput="updateSliderValue('expectedUsersSlider', 'expectedUsersValue', '', true); updateFromSlider('expectedUsers', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Organization Growth: <span id="organizationGrowthValue">100</span>%</label>
                        <input type="range" id="organizationGrowthSlider" min="10" max="300" value="100" oninput="updateSliderValue('organizationGrowthSlider', 'organizationGrowthValue'); updateFromSlider('organizationGrowth', this.value);">
                    </div>
                </div>
                
                <div class="variable-group">
                    <h4>üë• Team Composition Controls</h4>
                    <div class="slider-control">
                        <label>Number of Experts: <span id="numExpertsValue">1</span></label>
                        <input type="range" id="numExpertsSlider" min="0" max="5" value="1" oninput="updateSliderValue('numExpertsSlider', 'numExpertsValue'); updateFromSlider('numExperts', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Number of Engineers: <span id="numEngineersValue">1</span></label>
                        <input type="range" id="numEngineersSlider" min="0" max="10" value="1" oninput="updateSliderValue('numEngineersSlider', 'numEngineersValue'); updateFromSlider('numEngineers', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Number of Frontend Engineers: <span id="numFrontendEngineersValue">2</span></label>
                        <input type="range" id="numFrontendEngineersSlider" min="0" max="10" value="2" oninput="updateSliderValue('numFrontendEngineersSlider', 'numFrontendEngineersValue'); updateFromSlider('numFrontendEngineers', this.value);">
                    </div>
                </div>
                
                <div class="variable-group">
                    <h4>‚òÅÔ∏è AWS Usage Controls</h4>
                    <div class="slider-control">
                        <label>Lambda Requests/Month: <span id="lambdaRequestsValue">10</span>M</label>
                        <input type="range" id="lambdaRequestsSlider" min="1" max="100" value="10" oninput="updateSliderValue('lambdaRequestsSlider', 'lambdaRequestsValue'); updateFromSlider('lambdaRequestsPerMonth', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>API Gateway Requests: <span id="apiGatewayRequestsValue">10</span>M</label>
                        <input type="range" id="apiGatewayRequestsSlider" min="1" max="100" value="10" oninput="updateSliderValue('apiGatewayRequestsSlider', 'apiGatewayRequestsValue'); updateFromSlider('apiGatewayRequests', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>CloudFront Data Transfer: <span id="cloudFrontDataValue">500</span>GB</label>
                        <input type="range" id="cloudFrontDataSlider" min="50" max="5000" value="500" oninput="updateSliderValue('cloudFrontDataSlider', 'cloudFrontDataValue'); updateFromSlider('cloudFrontData', this.value);">
                    </div>
                </div>
                
                <div class="variable-group">
                    <h4>üí∞ Cost Controls</h4>
                    <div class="slider-control">
                        <label>Expert Daily Rate: $<span id="expertRateValue">2,250</span></label>
                        <input type="range" id="expertRateSlider" min="1000" max="5000" value="2250" oninput="updateSliderValue('expertRateSlider', 'expertRateValue', '', true); updateFromSlider('expertRate', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Engineer Daily Rate: $<span id="engineerRateValue">2,000</span></label>
                        <input type="range" id="engineerRateSlider" min="1000" max="4000" value="2000" oninput="updateSliderValue('engineerRateSlider', 'engineerRateValue', '', true); updateFromSlider('engineerRate', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Frontend Daily Rate: $<span id="frontendRateValue">1,500</span></label>
                        <input type="range" id="frontendRateSlider" min="800" max="3000" value="1500" oninput="updateSliderValue('frontendRateSlider', 'frontendRateValue', '', true); updateFromSlider('frontendRate', this.value);">
                    </div>
                </div>

                <div class="variable-group">
                    <h4>‚åö MVP Development Hours</h4>
                    <div class="slider-control">
                        <label>Expert Hours/Week: <span id="expertHoursValue">20</span></label>
                        <input type="range" id="expertHoursSlider" min="10" max="40" value="20" oninput="updateSliderValue('expertHoursSlider', 'expertHoursValue'); updateFromSlider('expertHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Engineer Hours/Week: <span id="engineerHoursValue">20</span></label>
                        <input type="range" id="engineerHoursSlider" min="10" max="40" value="20" oninput="updateSliderValue('engineerHoursSlider', 'engineerHoursValue'); updateFromSlider('engineerHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Frontend Hours/Week: <span id="frontendHoursValue">20</span></label>
                        <input type="range" id="frontendHoursSlider" min="10" max="40" value="20" oninput="updateSliderValue('frontendHoursSlider', 'frontendHoursValue'); updateFromSlider('frontendHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>MVP Duration: <span id="mvpDurationValue">6</span> months</label>
                        <input type="range" id="mvpDurationSlider" min="3" max="12" value="6" oninput="updateSliderValue('mvpDurationSlider', 'mvpDurationValue'); updateFromSlider('mvpDuration', this.value);">
                    </div>
                </div>

                <div class="variable-group">
                    <h4>üîß Ongoing Maintenance</h4>
                    <div class="slider-control">
                        <label>Expert Hours/Month: <span id="expertMaintenanceHoursValue">15</span></label>
                        <input type="range" id="expertMaintenanceHoursSlider" min="5" max="40" value="15" oninput="updateSliderValue('expertMaintenanceHoursSlider', 'expertMaintenanceHoursValue'); updateFromSlider('expertMaintenanceHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Engineer Hours/Month: <span id="engineerMaintenanceHoursValue">20</span></label>
                        <input type="range" id="engineerMaintenanceHoursSlider" min="5" max="40" value="20" oninput="updateSliderValue('engineerMaintenanceHoursSlider', 'engineerMaintenanceHoursValue'); updateFromSlider('engineerMaintenanceHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Frontend Hours/Month: <span id="frontendMaintenanceHoursValue">17</span></label>
                        <input type="range" id="frontendMaintenanceHoursSlider" min="5" max="40" value="17" oninput="updateSliderValue('frontendMaintenanceHoursSlider', 'frontendMaintenanceHoursValue'); updateFromSlider('frontendMaintenanceHours', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Maintenance Rate: <span id="maintenanceRateMultiplierValue">85</span>%</label>
                        <input type="range" id="maintenanceRateMultiplierSlider" min="50" max="100" value="85" oninput="updateSliderValue('maintenanceRateMultiplierSlider', 'maintenanceRateMultiplierValue'); updateFromSlider('maintenanceRateMultiplier', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Support Growth Rate: <span id="supportGrowthValue">25</span>%</label>
                        <input type="range" id="supportGrowthSlider" min="0" max="50" value="25" oninput="updateSliderValue('supportGrowthSlider', 'supportGrowthValue'); updateFromSlider('supportGrowth', this.value);">
                    </div>
                </div>

                <div class="variable-group">
                    <h4>üï∏Ô∏è Graph Database Options</h4>
                    <div class="input-row">
                        <label>Graph Database Setup:</label>
                        <select id="graphDbOption" onchange="calculateTCO()">
                            <option value="free">Free Neo4j (Docker/Community)</option>
                            <option value="paid">Paid Neo4j (Discovery Bundle)</option>
                        </select>
                    </div>
                    <div class="slider-control">
                        <label>Number of Organizations: <span id="numOrganizationsValue">2</span></label>
                        <input type="range" id="numOrganizationsSlider" min="1" max="50" value="2" oninput="updateSliderValue('numOrganizationsSlider', 'numOrganizationsValue'); updateFromSlider('numOrganizations', this.value); autoSwitchNeo4jPaid(this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Organizations per Instance: <span id="orgsPerInstanceValue">4</span></label>
                        <input type="range" id="orgsPerInstanceSlider" min="1" max="10" value="4" oninput="updateSliderValue('orgsPerInstanceSlider', 'orgsPerInstanceValue'); updateFromSlider('orgsPerInstance', this.value);">
                    </div>
                    <div class="slider-control">
                        <label>Neo4j Bundle Cost: $<span id="neo4jInstanceCostValue">53,000</span></label>
                        <input type="range" id="neo4jInstanceCostSlider" min="10000" max="100000" value="53000" oninput="updateSliderValue('neo4jInstanceCostSlider', 'neo4jInstanceCostValue', '', true); updateFromSlider('neo4jInstanceCost', this.value);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Visualizations Grid -->
        <div class="chart-grid-2x2">
            <div class="chart-container">
                <h3>üìà Cost Over Time</h3>
                <div class="chart-box">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>ü•ß Cost Breakdown by Category</h3>
                <div class="chart-box">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üìä Cost Composition by Year</h3>
                <div class="chart-box">
                    <canvas id="yearlyStackedChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>‚òÅÔ∏è AWS Services Breakdown</h3>
                <div class="chart-box">
                    <canvas id="awsBreakdownChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Insights -->
        <div class="chart-grid-1x2">
            <div class="chart-container">
                <h3>üí° Cost Per User by Scale</h3>
                <div class="chart-box">
                    <canvas id="scaleEfficiencyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üìà Growth Impact</h3>
                <div class="chart-box">
                    <canvas id="growthImpactChart"></canvas>
                </div>
            </div>
        </div>

        <div class="user-cost-analysis">
            <h2>üìä Cost Per User Analysis</h2>
            <table>
                <thead>
                    <tr class="section-header">
                        <th>User Segment</th>
                        <th>Fixed Cost/User/Month</th>
                        <th>Variable Cost/User/Month</th>
                        <th>Total Cost/User/Month</th>
                        <th>Efficiency vs Base</th>
                    </tr>
                </thead>
                <tbody id="userAnalysisBody">
                </tbody>
            </table>
        </div>

        <h2>üìã Detailed Cost Breakdown</h2>
        <table id="tcoTable">
            <thead>
                <tr class="section-header">
                    <th>Cost Category</th>
                    <th>Year 1</th>
                    <th>Year 2</th>
                    <th>Year 3</th>
                    <th>3-Year Total</th>
                </tr>
            </thead>
            <tbody id="tcoBody">
            </tbody>
        </table>

        <h2>üìä Cost Analysis</h2>
        <table id="analysisTable">
            <thead>
                <tr class="section-header">
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="analysisBody">
            </tbody>
        </table>
    </div>

    <!-- Hidden input fields for calculations (complete original set) -->
    <div style="display: none;">
        <input type="number" id="numExperts" value="1">
        <input type="number" id="numEngineers" value="1">
        <input type="number" id="numFrontendEngineers" value="2">
        <input type="number" id="expertRate" value="2250">
        <input type="number" id="engineerRate" value="2000">
        <input type="number" id="frontendRate" value="1500">
        <input type="number" id="expertHours" value="20">
        <input type="number" id="engineerHours" value="20">
        <input type="number" id="frontendHours" value="20">
        <input type="number" id="mvpDuration" value="6">
        <input type="number" id="workingDays" value="21">
        <input type="number" id="expectedUsers" value="20000">
        <input type="number" id="numOrganizations" value="2">
        <input type="number" id="userGrowth" value="10">
        <input type="number" id="organizationGrowth" value="100">
        <input type="number" id="expertMaintenanceHours" value="15">
        <input type="number" id="engineerMaintenanceHours" value="20">
        <input type="number" id="frontendMaintenanceHours" value="17">
        <input type="number" id="maintenanceRateMultiplier" value="85">
        <input type="number" id="licensing" value="300">
        <input type="number" id="licensingGrowth" value="20">
        <input type="number" id="dynamodbCost" value="200">
        <input type="number" step="0.01" id="cognitoCostPerUser" value="0.05">
        <input type="number" step="0.1" id="lambdaRequestsPerMonth" value="10">
        <input type="number" step="0.01" id="lambdaCostPerMillion" value="0.20">
        <input type="number" step="0.1" id="apiGatewayRequests" value="10">
        <input type="number" step="0.01" id="apiGatewayCostPerMillion" value="3.50">
        <input type="number" step="0.1" id="cloudFrontData" value="500">
        <input type="number" step="0.001" id="cloudFrontCostPerGB" value="0.085">
        <input type="number" step="0.1" id="s3Storage" value="100">
        <input type="number" step="0.001" id="s3CostPerGB" value="0.023">
        <input type="number" step="0.1" id="cloudWatchLogs" value="10">
        <input type="number" step="0.01" id="cloudWatchCostPerGB" value="0.50">
        <input type="number" step="0.1" id="eventBridgeEvents" value="1">
        <input type="number" step="0.01" id="eventBridgeCostPerMillion" value="1.00">
        <input type="number" step="0.1" id="sqsMessages" value="5">
        <input type="number" step="0.01" id="sqsCostPerMillion" value="0.40">
        <input type="number" id="lambdaGrowth" value="40">
        <input type="number" id="storageGrowth" value="30">
        <input type="number" id="dataTransferGrowth" value="35">
        <input type="number" id="logsGrowth" value="25">
        <input type="number" id="apiRequestsPerUser" value="1000">
        <input type="number" step="0.1" id="dataPerUser" value="500">
        <input type="number" step="0.1" id="storagePerUser" value="100">
        <input type="number" id="activeUserRate" value="70">
        <input type="number" id="orgsPerInstance" value="4">
        <input type="number" id="neo4jInstanceCost" value="55000">
        <input type="number" id="hosting" value="150">
        <input type="number" id="devTools" value="3000">
        <input type="number" id="thirdParty" value="200">
        <input type="number" id="hostingGrowth" value="50">
        <input type="number" id="supportGrowth" value="25">
    </div>

    <script>
        // Chart instances
        let charts = {};

        // Color schemes
        const colorSchemes = {
            primary: ['#1976D2', '#2196F3', '#42A5F5', '#64B5F6', '#90CAF9'],
            categories: ['#1976D2', '#388E3C', '#F57C00', '#7B1FA2', '#D32F2F', '#795548', '#607D8B'],
            aws: ['#FF9800', '#FF5722', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#00BCD4', '#4CAF50']
        };

        // Utility functions
        function updateSliderValue(sliderId, valueId, suffix = '', formatNumber = false) {
            const slider = document.getElementById(sliderId);
            const valueElement = document.getElementById(valueId);
            let value = slider.value;
            
            if (formatNumber) {
                value = parseInt(value).toLocaleString();
            }
            
            valueElement.textContent = value + suffix;
        }

        function updateFromSlider(inputId, value) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value;
                calculateTCO();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatCurrencyPrecise(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Chart creation functions
        function createTimelineChart(data) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            if (charts.timeline) charts.timeline.destroy();
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.timeLabels.map((_, i) => `Month ${i + 1}`),
                    datasets: [{
                        label: 'Total Monthly Cost',
                        data: data.monthlyCosts,
                        borderColor: colorSchemes.primary[0],
                        backgroundColor: colorSchemes.primary[0] + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => 'Cost: ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function createCategoryPieChart(breakdown) {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            if (charts.categoryPie) charts.categoryPie.destroy();
            
            charts.categoryPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: breakdown.labels,
                    datasets: [{
                        data: breakdown.values,
                        backgroundColor: colorSchemes.categories,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const percentage = ((context.parsed / breakdown.total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createYearlyStackedChart(yearlyData) {
            const ctx = document.getElementById('yearlyStackedChart').getContext('2d');
            if (charts.yearlyStacked) charts.yearlyStacked.destroy();
            
            const datasets = yearlyData.categories.map((category, i) => ({
                label: category,
                data: yearlyData.years.map(year => yearlyData.data[year][category]),
                backgroundColor: colorSchemes.categories[i],
                borderColor: colorSchemes.categories[i],
                borderWidth: 1
            }));
            
            charts.yearlyStacked = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: yearlyData.years.map(y => `Year ${y}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    }
                }
            });
        }

        function createAWSBreakdownChart(awsData) {
            const ctx = document.getElementById('awsBreakdownChart').getContext('2d');
            if (charts.awsBreakdown) charts.awsBreakdown.destroy();
            
            charts.awsBreakdown = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: awsData.labels,
                    datasets: [{
                        data: awsData.values,
                        backgroundColor: colorSchemes.aws,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, usePointStyle: true, font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const percentage = ((context.parsed / awsData.total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createScaleEfficiencyChart(scaleData) {
            const ctx = document.getElementById('scaleEfficiencyChart').getContext('2d');
            if (charts.scaleEfficiency) charts.scaleEfficiency.destroy();
            
            charts.scaleEfficiency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: scaleData.userCounts.map(u => u >= 1000 ? `${(u/1000).toFixed(0)}K` : u.toString()),
                    datasets: [{
                        label: 'Cost Per User',
                        data: scaleData.costPerUser,
                        borderColor: colorSchemes.primary[2],
                        backgroundColor: colorSchemes.primary[2] + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Cost: ${formatCurrencyPrecise(context.parsed.y)}/user/month`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => '$' + value.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function createGrowthImpactChart(growthData) {
            const ctx = document.getElementById('growthImpactChart').getContext('2d');
            if (charts.growthImpact) charts.growthImpact.destroy();
            
            charts.growthImpact = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: growthData.labels,
                    datasets: [{
                        label: 'Total Cost',
                        data: growthData.totalCosts,
                        backgroundColor: colorSchemes.primary[1],
                        borderColor: colorSchemes.primary[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Total: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Complete calculateTCO function (restored from original)
        function calculateTCO() {
            // Get all input values
            const numExperts = parseFloat(document.getElementById('numExperts').value);
            const numEngineers = parseFloat(document.getElementById('numEngineers').value);
            const numFrontendEngineers = parseFloat(document.getElementById('numFrontendEngineers').value);
            const expertRate = parseFloat(document.getElementById('expertRate').value);
            const engineerRate = parseFloat(document.getElementById('engineerRate').value);
            const frontendRate = parseFloat(document.getElementById('frontendRate').value);
            const expertHours = parseFloat(document.getElementById('expertHours').value);
            const engineerHours = parseFloat(document.getElementById('engineerHours').value);
            const frontendHours = parseFloat(document.getElementById('frontendHours').value);
            const mvpDuration = parseFloat(document.getElementById('mvpDuration').value);
            const workingDays = parseFloat(document.getElementById('workingDays').value);
            const expectedUsers = parseFloat(document.getElementById('expectedUsers').value);
            const numOrganizations = parseFloat(document.getElementById('numOrganizations').value);
            
            // Graph Database variables
            const graphDbOption = document.getElementById('graphDbOption').value;
            const orgsPerInstance = parseFloat(document.getElementById('orgsPerInstance').value);
            const neo4jInstanceCost = parseFloat(document.getElementById('neo4jInstanceCost').value);
            const organizationGrowth = parseFloat(document.getElementById('organizationGrowth').value) / 100;
            
            // Ongoing maintenance variables
            const expertMaintenanceHours = parseFloat(document.getElementById('expertMaintenanceHours').value);
            const engineerMaintenanceHours = parseFloat(document.getElementById('engineerMaintenanceHours').value);
            const frontendMaintenanceHours = parseFloat(document.getElementById('frontendMaintenanceHours').value);
            const maintenanceRateMultiplier = parseFloat(document.getElementById('maintenanceRateMultiplier').value) / 100;
            
            const hosting = parseFloat(document.getElementById('hosting').value);
            const devTools = parseFloat(document.getElementById('devTools').value);
            const thirdParty = parseFloat(document.getElementById('thirdParty').value);
            const licensing = parseFloat(document.getElementById('licensing').value);
            const hostingGrowth = parseFloat(document.getElementById('hostingGrowth').value) / 100;
            const supportGrowth = parseFloat(document.getElementById('supportGrowth').value) / 100;
            const licensingGrowth = parseFloat(document.getElementById('licensingGrowth').value) / 100;
            
            // AWS Services variables
            const dynamodbCost = parseFloat(document.getElementById('dynamodbCost').value);
            const cognitoCostPerUser = parseFloat(document.getElementById('cognitoCostPerUser').value);
            const lambdaRequestsPerMonth = parseFloat(document.getElementById('lambdaRequestsPerMonth').value);
            const lambdaCostPerMillion = parseFloat(document.getElementById('lambdaCostPerMillion').value);
            const userGrowth = parseFloat(document.getElementById('userGrowth').value) / 100;
            
            // Additional AWS Services
            const apiGatewayRequests = parseFloat(document.getElementById('apiGatewayRequests').value);
            const apiGatewayCostPerMillion = parseFloat(document.getElementById('apiGatewayCostPerMillion').value);
            const cloudFrontData = parseFloat(document.getElementById('cloudFrontData').value);
            const cloudFrontCostPerGB = parseFloat(document.getElementById('cloudFrontCostPerGB').value);
            const s3Storage = parseFloat(document.getElementById('s3Storage').value);
            const s3CostPerGB = parseFloat(document.getElementById('s3CostPerGB').value);
            const cloudWatchLogs = parseFloat(document.getElementById('cloudWatchLogs').value);
            const cloudWatchCostPerGB = parseFloat(document.getElementById('cloudWatchCostPerGB').value);
            const eventBridgeEvents = parseFloat(document.getElementById('eventBridgeEvents').value);
            const eventBridgeCostPerMillion = parseFloat(document.getElementById('eventBridgeCostPerMillion').value);
            const sqsMessages = parseFloat(document.getElementById('sqsMessages').value);
            const sqsCostPerMillion = parseFloat(document.getElementById('sqsCostPerMillion').value);
            
            // Growth rates
            const lambdaGrowth = parseFloat(document.getElementById('lambdaGrowth').value) / 100;
            const storageGrowth = parseFloat(document.getElementById('storageGrowth').value) / 100;
            const dataTransferGrowth = parseFloat(document.getElementById('dataTransferGrowth').value) / 100;
            const logsGrowth = parseFloat(document.getElementById('logsGrowth').value) / 100;
            
            // User behavior
            const apiRequestsPerUser = parseFloat(document.getElementById('apiRequestsPerUser').value);
            const dataPerUser = parseFloat(document.getElementById('dataPerUser').value);
            const storagePerUser = parseFloat(document.getElementById('storagePerUser').value);
            const activeUserRate = parseFloat(document.getElementById('activeUserRate').value) / 100;

            // Calculate time factors
            const expertTimeFactor = expertHours / 40;
            const engineerTimeFactor = engineerHours / 40;
            const frontendTimeFactor = frontendHours / 40;

            // Calculate MVP costs
            const mvpExpertCost = expertRate * workingDays * mvpDuration * expertTimeFactor * numExperts;
            const mvpEngineerCost = engineerRate * workingDays * mvpDuration * engineerTimeFactor * numEngineers;
            const mvpFrontendCost = frontendRate * workingDays * mvpDuration * frontendTimeFactor * numFrontendEngineers;
            const mvpTotal = mvpExpertCost + mvpEngineerCost + mvpFrontendCost;

            // Calculate maintenance hourly rates
            const maintenanceExpertHourlyRate = (expertRate / 8) * maintenanceRateMultiplier;
            const maintenanceEngineerHourlyRate = (engineerRate / 8) * maintenanceRateMultiplier;
            const maintenanceFrontendHourlyRate = (frontendRate / 8) * maintenanceRateMultiplier;

            // Calculate base monthly maintenance costs
            const baseMaintenanceMonthly = (maintenanceExpertHourlyRate * expertMaintenanceHours * numExperts) + 
                                         (maintenanceEngineerHourlyRate * engineerMaintenanceHours * numEngineers) + 
                                         (maintenanceFrontendHourlyRate * frontendMaintenanceHours * numFrontendEngineers);
            
            // Year 1-3 Development costs
            const year1Maintenance = baseMaintenanceMonthly * (12 - mvpDuration);
            const year1Development = mvpTotal + year1Maintenance;
            const year2Development = baseMaintenanceMonthly * 12 * (1 + supportGrowth);
            const year3Development = baseMaintenanceMonthly * 12 * Math.pow(1 + supportGrowth, 2);

            // Infrastructure costs
            const year1Hosting = hosting * 12;
            const year2Hosting = hosting * 12 * (1 + hostingGrowth);
            const year3Hosting = hosting * 12 * Math.pow(1 + hostingGrowth, 2);

            const year1ThirdParty = thirdParty * 12;
            const year2ThirdParty = thirdParty * 12 * 1.1;
            const year3ThirdParty = thirdParty * 12 * 1.21;

            const year1Licensing = licensing * 12;
            const year2Licensing = licensing * 12 * (1 + licensingGrowth);
            const year3Licensing = licensing * 12 * Math.pow(1 + licensingGrowth, 2);

            const annualDevTools = devTools;

            // Graph Database costs
            const calculateNeo4jInstances = (orgs) => Math.ceil(orgs / orgsPerInstance);
            
            let year1GraphDB = 0, year2GraphDB = 0, year3GraphDB = 0;
            
            if (graphDbOption === 'paid') {
                const year1Orgs = numOrganizations;
                const year2Orgs = numOrganizations * (1 + organizationGrowth);
                const year3Orgs = numOrganizations * Math.pow(1 + organizationGrowth, 2);
                
                const year1Instances = calculateNeo4jInstances(year1Orgs);
                const year2Instances = calculateNeo4jInstances(year2Orgs);
                const year3Instances = calculateNeo4jInstances(year3Orgs);
                
                year1GraphDB = year1Instances * neo4jInstanceCost;
                year2GraphDB = year2Instances * neo4jInstanceCost;
                year3GraphDB = year3Instances * neo4jInstanceCost;
            }

            // AWS Services costs with all services
            const year1Users = expectedUsers;
            const year2Users = expectedUsers * (1 + userGrowth);
            const year3Users = expectedUsers * Math.pow(1 + userGrowth, 2);
            
            // Year 1 AWS costs
            const year1DynamoDB = dynamodbCost * 12;
            const year1Cognito = cognitoCostPerUser * year1Users * 12;
            const year1Lambda = lambdaCostPerMillion * lambdaRequestsPerMonth * 12;
            const year1ApiGateway = apiGatewayCostPerMillion * apiGatewayRequests * 12;
            const year1CloudFront = cloudFrontCostPerGB * cloudFrontData * 12;
            const year1S3 = s3CostPerGB * s3Storage * 12;
            const year1CloudWatch = cloudWatchCostPerGB * cloudWatchLogs * 12;
            const year1EventBridge = eventBridgeCostPerMillion * eventBridgeEvents * 12;
            const year1SQS = sqsCostPerMillion * sqsMessages * 12;
            
            const year1AWSTotal = year1DynamoDB + year1Cognito + year1Lambda + year1ApiGateway + 
                                year1CloudFront + year1S3 + year1CloudWatch + year1EventBridge + year1SQS;

            // Year 2 AWS costs
            const year2DynamoDB = dynamodbCost * 12 * (1 + storageGrowth);
            const year2Cognito = cognitoCostPerUser * year2Users * 12;
            const year2Lambda = lambdaCostPerMillion * lambdaRequestsPerMonth * 12 * (1 + lambdaGrowth);
            const year2ApiGateway = apiGatewayCostPerMillion * apiGatewayRequests * 12 * (1 + lambdaGrowth);
            const year2CloudFront = cloudFrontCostPerGB * cloudFrontData * 12 * (1 + dataTransferGrowth);
            const year2S3 = s3CostPerGB * s3Storage * 12 * (1 + storageGrowth);
            const year2CloudWatch = cloudWatchCostPerGB * cloudWatchLogs * 12 * (1 + logsGrowth);
            const year2EventBridge = eventBridgeCostPerMillion * eventBridgeEvents * 12 * (1 + lambdaGrowth);
            const year2SQS = sqsCostPerMillion * sqsMessages * 12 * (1 + lambdaGrowth);
            
            const year2AWSTotal = year2DynamoDB + year2Cognito + year2Lambda + year2ApiGateway + 
                                year2CloudFront + year2S3 + year2CloudWatch + year2EventBridge + year2SQS;

            // Year 3 AWS costs
            const year3DynamoDB = dynamodbCost * 12 * Math.pow(1 + storageGrowth, 2);
            const year3Cognito = cognitoCostPerUser * year3Users * 12;
            const year3Lambda = lambdaCostPerMillion * lambdaRequestsPerMonth * 12 * Math.pow(1 + lambdaGrowth, 2);
            const year3ApiGateway = apiGatewayCostPerMillion * apiGatewayRequests * 12 * Math.pow(1 + lambdaGrowth, 2);
            const year3CloudFront = cloudFrontCostPerGB * cloudFrontData * 12 * Math.pow(1 + dataTransferGrowth, 2);
            const year3S3 = s3CostPerGB * s3Storage * 12 * Math.pow(1 + storageGrowth, 2);
            const year3CloudWatch = cloudWatchCostPerGB * cloudWatchLogs * 12 * Math.pow(1 + logsGrowth, 2);
            const year3EventBridge = eventBridgeCostPerMillion * eventBridgeEvents * 12 * Math.pow(1 + lambdaGrowth, 2);
            const year3SQS = sqsCostPerMillion * sqsMessages * 12 * Math.pow(1 + lambdaGrowth, 2);
            
            const year3AWSTotal = year3DynamoDB + year3Cognito + year3Lambda + year3ApiGateway + 
                                year3CloudFront + year3S3 + year3CloudWatch + year3EventBridge + year3SQS;

            // Calculate totals
            const year1Total = year1Development + year1Hosting + year1ThirdParty + year1Licensing + annualDevTools + year1AWSTotal + year1GraphDB;
            const year2Total = year2Development + year2Hosting + year2ThirdParty + year2Licensing + annualDevTools + year2AWSTotal + year2GraphDB;
            const year3Total = year3Development + year3Hosting + year3ThirdParty + year3Licensing + annualDevTools + year3AWSTotal + year3GraphDB;
            const threeYearTotal = year1Total + year2Total + year3Total;

            // Calculate per-user costs
            const avgUsers = (year1Users + year2Users + year3Users) / 3;
            const costPerUser = avgUsers > 0 ? threeYearTotal / avgUsers : 0;
            const monthlyCostPerUser = avgUsers > 0 ? threeYearTotal / (avgUsers * 36) : 0;

            // Update summary display
            document.getElementById('totalTCO').textContent = formatCurrency(threeYearTotal);
            document.getElementById('costPerUser').textContent = formatCurrencyPrecise(costPerUser);
            document.getElementById('monthlyCostPerUser').textContent = formatCurrencyPrecise(monthlyCostPerUser);

            // Generate timeline data for charts
            const timelineData = generateTimelineData(expectedUsers, userGrowth, mvpDuration, baseMaintenanceMonthly, supportGrowth, hosting, hostingGrowth, thirdParty, licensing, licensingGrowth, devTools, year1AWSTotal, year2AWSTotal, year3AWSTotal, year1GraphDB, year2GraphDB, year3GraphDB, mvpTotal);

            const categoryBreakdown = {
                labels: ['Development Team', 'AWS Services', 'Infrastructure', 'Graph Database', 'Licensing', 'Dev Tools'],
                values: [
                    year1Development + year2Development + year3Development,
                    year1AWSTotal + year2AWSTotal + year3AWSTotal,
                    year1Hosting + year2Hosting + year3Hosting + year1ThirdParty + year2ThirdParty + year3ThirdParty,
                    year1GraphDB + year2GraphDB + year3GraphDB,
                    year1Licensing + year2Licensing + year3Licensing,
                    annualDevTools * 3
                ],
                total: threeYearTotal
            };

            const yearlyData = {
                years: [1, 2, 3],
                categories: ['Development', 'AWS Services', 'Infrastructure', 'Graph DB', 'Licensing', 'Dev Tools'],
                data: {
                    1: {
                        'Development': year1Development,
                        'AWS Services': year1AWSTotal,
                        'Infrastructure': year1Hosting + year1ThirdParty,
                        'Graph DB': year1GraphDB,
                        'Licensing': year1Licensing,
                        'Dev Tools': annualDevTools
                    },
                    2: {
                        'Development': year2Development,
                        'AWS Services': year2AWSTotal,
                        'Infrastructure': year2Hosting + year2ThirdParty,
                        'Graph DB': year2GraphDB,
                        'Licensing': year2Licensing,
                        'Dev Tools': annualDevTools
                    },
                    3: {
                        'Development': year3Development,
                        'AWS Services': year3AWSTotal,
                        'Infrastructure': year3Hosting + year3ThirdParty,
                        'Graph DB': year3GraphDB,
                        'Licensing': year3Licensing,
                        'Dev Tools': annualDevTools
                    }
                }
            };

            const awsBreakdown = {
                labels: ['DynamoDB', 'Cognito', 'Lambda', 'API Gateway', 'CloudFront', 'S3', 'CloudWatch', 'EventBridge', 'SQS'],
                values: [
                    year1DynamoDB + year2DynamoDB + year3DynamoDB,
                    year1Cognito + year2Cognito + year3Cognito,
                    year1Lambda + year2Lambda + year3Lambda,
                    year1ApiGateway + year2ApiGateway + year3ApiGateway,
                    year1CloudFront + year2CloudFront + year3CloudFront,
                    year1S3 + year2S3 + year3S3,
                    year1CloudWatch + year2CloudWatch + year3CloudWatch,
                    year1EventBridge + year2EventBridge + year3EventBridge,
                    year1SQS + year2SQS + year3SQS
                ],
                total: year1AWSTotal + year2AWSTotal + year3AWSTotal
            };

            const scaleData = generateScaleData(expectedUsers, year1Users, year2Users, year3Users, year1Total, year2Total, year3Total);
            const growthData = generateGrowthData(expectedUsers, userGrowth, threeYearTotal);

            // Create all charts
            createTimelineChart(timelineData);
            createCategoryPieChart(categoryBreakdown);
            createYearlyStackedChart(yearlyData);
            createAWSBreakdownChart(awsBreakdown);
            createScaleEfficiencyChart(scaleData);
            createGrowthImpactChart(growthData);

            // Update user analysis table
            updateUserAnalysisTable(year1Users, year2Users, year3Users, avgUsers, year1Development, year2Development, year3Development, year1Hosting, year2Hosting, year3Hosting, year1ThirdParty, year2ThirdParty, year3ThirdParty, year1Licensing, year2Licensing, year3Licensing, annualDevTools, year1GraphDB, year2GraphDB, year3GraphDB, year1AWSTotal, year2AWSTotal, year3AWSTotal, monthlyCostPerUser);

            // Update detailed table
            updateDetailedTable(year1Development, year2Development, year3Development, mvpTotal, year1Maintenance, year1Hosting, year2Hosting, year3Hosting, year1Licensing, year2Licensing, year3Licensing, year1GraphDB, year2GraphDB, year3GraphDB, graphDbOption, annualDevTools, year1ThirdParty, year2ThirdParty, year3ThirdParty, year1AWSTotal, year2AWSTotal, year3AWSTotal, year1DynamoDB, year2DynamoDB, year3DynamoDB, year1Cognito, year2Cognito, year3Cognito, year1Lambda, year2Lambda, year3Lambda, year1ApiGateway, year2ApiGateway, year3ApiGateway, year1CloudFront, year2CloudFront, year3CloudFront, year1S3, year2S3, year3S3, year1CloudWatch, year2CloudWatch, year3CloudWatch, year1EventBridge, year2EventBridge, year3EventBridge, year1SQS, year2SQS, year3SQS, year1Total, year2Total, year3Total, threeYearTotal);

            // Update analysis table
            updateAnalysisTable(threeYearTotal, avgUsers, costPerUser, monthlyCostPerUser, activeUserRate, year1Development, year2Development, year3Development, mvpTotal, year1Hosting, year2Hosting, year3Hosting, year1Licensing, year2Licensing, year3Licensing, year1ThirdParty, year2ThirdParty, year3ThirdParty, annualDevTools, year1AWSTotal, year2AWSTotal, year3AWSTotal, year1GraphDB, year2GraphDB, year3GraphDB, graphDbOption, numOrganizations, organizationGrowth, orgsPerInstance, year3Users, baseMaintenanceMonthly, supportGrowth, numExperts, numEngineers, numFrontendEngineers, apiRequestsPerUser, apiGatewayRequests, lambdaGrowth, mvpDuration, workingDays, expertHours, engineerHours, frontendHours, expertMaintenanceHours, engineerMaintenanceHours, frontendMaintenanceHours);
        }

        function generateTimelineData(expectedUsers, userGrowth, mvpDuration, baseMaintenanceMonthly, supportGrowth, hosting, hostingGrowth, thirdParty, licensing, licensingGrowth, devTools, year1AWS, year2AWS, year3AWS, year1GraphDB, year2GraphDB, year3GraphDB, mvpTotal) {
            const months = 36;
            const timeLabels = [];
            const monthlyCosts = [];
            
            for (let month = 1; month <= months; month++) {
                timeLabels.push(month);
                
                let monthlyCost = 0;
                
                // Development costs
                if (month <= mvpDuration) {
                    monthlyCost += mvpTotal / mvpDuration;
                } else {
                    const maintenanceGrowth = Math.pow(1 + supportGrowth, Math.floor((month - mvpDuration - 1) / 12));
                    monthlyCost += baseMaintenanceMonthly * maintenanceGrowth;
                }
                
                // Infrastructure
                const infrastructureGrowth = Math.pow(1 + hostingGrowth, Math.floor((month - 1) / 12));
                monthlyCost += hosting * infrastructureGrowth;
                monthlyCost += thirdParty * Math.pow(1.1, Math.floor((month - 1) / 12));
                monthlyCost += licensing * Math.pow(1 + licensingGrowth, Math.floor((month - 1) / 12));
                
                // Dev tools (annual)
                if (month % 12 === 1) {
                    monthlyCost += devTools;
                }
                
                // AWS & Graph DB (simplified monthly average)
                const year = Math.ceil(month / 12);
                if (year === 1) {
                    monthlyCost += year1AWS / 12 + year1GraphDB / 12;
                } else if (year === 2) {
                    monthlyCost += year2AWS / 12 + year2GraphDB / 12;
                } else {
                    monthlyCost += year3AWS / 12 + year3GraphDB / 12;
                }
                
                monthlyCosts.push(monthlyCost);
            }
            
            return { timeLabels, monthlyCosts };
        }

        function generateScaleData(expectedUsers, year1Users, year2Users, year3Users, year1Total, year2Total, year3Total) {
            const userCounts = [
                Math.round(expectedUsers * 0.1),
                Math.round(expectedUsers * 0.5),
                Math.round(year1Users),
                Math.round(year2Users),
                Math.round(year3Users)
            ].filter(u => u > 0).sort((a, b) => a - b);
            
            // Simplified cost per user calculation
            const avgTotal = (year1Total + year2Total + year3Total) / 3;
            const avgUsers = (year1Users + year2Users + year3Users) / 3;
            
            const costPerUser = userCounts.map(users => {
                // Fixed costs don't scale, variable costs do
                const fixedPortion = avgTotal * 0.7; // Assume 70% fixed
                const variablePortion = avgTotal * 0.3; // 30% variable
                const scaleFactor = users / avgUsers;
                return (fixedPortion / users + variablePortion * scaleFactor / users) / 12;
            });
            
            return { userCounts, costPerUser };
        }

        function generateGrowthData(expectedUsers, userGrowth, baseCost) {
            const growthRates = [5, 10, 25, 50, 100, 200];
            const labels = growthRates.map(rate => `${rate}% Growth`);
            
            const totalCosts = growthRates.map(rate => {
                const growthMultiplier = 1 + (rate / 100) * 0.3; // Growth impact
                return baseCost * growthMultiplier;
            });
            
            return { labels, totalCosts };
        }

        function updateUserAnalysisTable(year1Users, year2Users, year3Users, avgUsers, year1Development, year2Development, year3Development, year1Hosting, year2Hosting, year3Hosting, year1ThirdParty, year2ThirdParty, year3ThirdParty, year1Licensing, year2Licensing, year3Licensing, annualDevTools, year1GraphDB, year2GraphDB, year3GraphDB, year1AWSTotal, year2AWSTotal, year3AWSTotal, monthlyCostPerUser) {
            const generateUserSegments = () => {
                const segments = [];
                const keyPoints = [
                    Math.round(year1Users * 0.1),
                    Math.round(year1Users * 0.5),
                    Math.round(year1Users),
                    Math.round(year2Users),
                    Math.round(year3Users)
                ].filter(p => p > 0).sort((a, b) => a - b);
                
                for (let i = 0; i < keyPoints.length; i++) {
                    const count = keyPoints[i];
                    let name;
                    
                    if (i === 0) {
                        name = `First ${count.toLocaleString()} users`;
                    } else {
                        const prevCount = keyPoints[i-1];
                        if (count === Math.round(year1Users)) {
                            name = `Year 1 projection (${count.toLocaleString()} users)`;
                        } else if (count === Math.round(year2Users)) {
                            name = `Year 2 projection (${count.toLocaleString()} users)`;
                        } else if (count === Math.round(year3Users)) {
                            name = `Year 3 projection (${count.toLocaleString()} users)`;
                        } else {
                            name = `${(prevCount + 1).toLocaleString()}-${count.toLocaleString()} users`;
                        }
                    }
                    
                    segments.push({ name, count });
                }
                
                return segments;
            };
            
            const userSegments = generateUserSegments();
            const userAnalysisBody = document.getElementById('userAnalysisBody');
            
            userAnalysisBody.innerHTML = userSegments.map(segment => {
                const fixedCostPerUser = ((year1Development + year2Development + year3Development) / 3 + 
                                         (year1Hosting + year2Hosting + year3Hosting) / 3 +
                                         (year1ThirdParty + year2ThirdParty + year3ThirdParty) / 3 +
                                         (year1Licensing + year2Licensing + year3Licensing) / 3 +
                                         annualDevTools +
                                         (year1GraphDB + year2GraphDB + year3GraphDB) / 3) / segment.count / 12;
                
                const variableCostPerUser = ((year1AWSTotal + year2AWSTotal + year3AWSTotal) / 3) / avgUsers / 12;
                const totalCostPerUser = fixedCostPerUser + variableCostPerUser;
                const efficiency = ((totalCostPerUser / monthlyCostPerUser - 1) * 100).toFixed(1);
                const efficiencyClass = efficiency < 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${segment.name}</td>
                        <td class="number currency">${formatCurrencyPrecise(fixedCostPerUser)}</td>
                        <td class="number currency">${formatCurrencyPrecise(variableCostPerUser)}</td>
                        <td class="number currency"><strong>${formatCurrencyPrecise(totalCostPerUser)}</strong></td>
                        <td class="number ${efficiencyClass}">${efficiency > 0 ? '+' : ''}${efficiency}%</td>
                    </tr>
                `;
            }).join('');
        }

        function updateDetailedTable(year1Development, year2Development, year3Development, mvpTotal, year1Maintenance, year1Hosting, year2Hosting, year3Hosting, year1Licensing, year2Licensing, year3Licensing, year1GraphDB, year2GraphDB, year3GraphDB, graphDbOption, annualDevTools, year1ThirdParty, year2ThirdParty, year3ThirdParty, year1AWSTotal, year2AWSTotal, year3AWSTotal, year1DynamoDB, year2DynamoDB, year3DynamoDB, year1Cognito, year2Cognito, year3Cognito, year1Lambda, year2Lambda, year3Lambda, year1ApiGateway, year2ApiGateway, year3ApiGateway, year1CloudFront, year2CloudFront, year3CloudFront, year1S3, year2S3, year3S3, year1CloudWatch, year2CloudWatch, year3CloudWatch, year1EventBridge, year2EventBridge, year3EventBridge, year1SQS, year2SQS, year3SQS, year1Total, year2Total, year3Total, threeYearTotal) {
            const tbody = document.getElementById('tcoBody');
            tbody.innerHTML = `
                <tr>
                    <td><strong>üë®‚Äçüíª Development Team</strong></td>
                    <td class="number currency">${formatCurrency(year1Development)}</td>
                    <td class="number currency">${formatCurrency(year2Development)}</td>
                    <td class="number currency">${formatCurrency(year3Development)}</td>
                    <td class="number currency">${formatCurrency(year1Development + year2Development + year3Development)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ MVP Development</td>
                    <td class="number currency">${formatCurrency(mvpTotal)}</td>
                    <td class="number currency">$0</td>
                    <td class="number currency">$0</td>
                    <td class="number currency">${formatCurrency(mvpTotal)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ Ongoing Maintenance & Support</td>
                    <td class="number currency">${formatCurrency(year1Maintenance)}</td>
                    <td class="number currency">${formatCurrency(year2Development)}</td>
                    <td class="number currency">${formatCurrency(year3Development)}</td>
                    <td class="number currency">${formatCurrency(year1Maintenance + year2Development + year3Development)}</td>
                </tr>
                <tr>
                    <td><strong>‚òÅÔ∏è Infrastructure & Hosting</strong></td>
                    <td class="number currency">${formatCurrency(year1Hosting)}</td>
                    <td class="number currency">${formatCurrency(year2Hosting)}</td>
                    <td class="number currency">${formatCurrency(year3Hosting)}</td>
                    <td class="number currency">${formatCurrency(year1Hosting + year2Hosting + year3Hosting)}</td>
                </tr>
                <tr>
                    <td><strong>üìÑ Software Licenses</strong></td>
                    <td class="number currency">${formatCurrency(year1Licensing)}</td>
                    <td class="number currency">${formatCurrency(year2Licensing)}</td>
                    <td class="number currency">${formatCurrency(year3Licensing)}</td>
                    <td class="number currency">${formatCurrency(year1Licensing + year2Licensing + year3Licensing)}</td>
                </tr>
                <tr>
                    <td><strong>üï∏Ô∏è Graph Database (${graphDbOption === 'free' ? 'Free Neo4j' : 'Neo4j Discovery'})</strong></td>
                    <td class="number currency">${formatCurrency(year1GraphDB)}</td>
                    <td class="number currency">${formatCurrency(year2GraphDB)}</td>
                    <td class="number currency">${formatCurrency(year3GraphDB)}</td>
                    <td class="number currency">${formatCurrency(year1GraphDB + year2GraphDB + year3GraphDB)}</td>
                </tr>
                <tr>
                    <td><strong>üîß Development Tools & Software</strong></td>
                    <td class="number currency">${formatCurrency(annualDevTools)}</td>
                    <td class="number currency">${formatCurrency(annualDevTools)}</td>
                    <td class="number currency">${formatCurrency(annualDevTools)}</td>
                    <td class="number currency">${formatCurrency(annualDevTools * 3)}</td>
                </tr>
                <tr>
                    <td><strong>üîå Third-party Services</strong></td>
                    <td class="number currency">${formatCurrency(year1ThirdParty)}</td>
                    <td class="number currency">${formatCurrency(year2ThirdParty)}</td>
                    <td class="number currency">${formatCurrency(year3ThirdParty)}</td>
                    <td class="number currency">${formatCurrency(year1ThirdParty + year2ThirdParty + year3ThirdParty)}</td>
                </tr>
                <tr>
                    <td><strong>‚òÅÔ∏è AWS Services Total</strong></td>
                    <td class="number currency">${formatCurrency(year1AWSTotal)}</td>
                    <td class="number currency">${formatCurrency(year2AWSTotal)}</td>
                    <td class="number currency">${formatCurrency(year3AWSTotal)}</td>
                    <td class="number currency">${formatCurrency(year1AWSTotal + year2AWSTotal + year3AWSTotal)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ DynamoDB</td>
                    <td class="number currency">${formatCurrency(year1DynamoDB)}</td>
                    <td class="number currency">${formatCurrency(year2DynamoDB)}</td>
                    <td class="number currency">${formatCurrency(year3DynamoDB)}</td>
                    <td class="number currency">${formatCurrency(year1DynamoDB + year2DynamoDB + year3DynamoDB)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ Cognito Authentication</td>
                    <td class="number currency">${formatCurrency(year1Cognito)}</td>
                    <td class="number currency">${formatCurrency(year2Cognito)}</td>
                    <td class="number currency">${formatCurrency(year3Cognito)}</td>
                    <td class="number currency">${formatCurrency(year1Cognito + year2Cognito + year3Cognito)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ Lambda Functions</td>
                    <td class="number currency">${formatCurrency(year1Lambda)}</td>
                    <td class="number currency">${formatCurrency(year2Lambda)}</td>
                    <td class="number currency">${formatCurrency(year3Lambda)}</td>
                    <td class="number currency">${formatCurrency(year1Lambda + year2Lambda + year3Lambda)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ API Gateway</td>
                    <td class="number currency">${formatCurrency(year1ApiGateway)}</td>
                    <td class="number currency">${formatCurrency(year2ApiGateway)}</td>
                    <td class="number currency">${formatCurrency(year3ApiGateway)}</td>
                    <td class="number currency">${formatCurrency(year1ApiGateway + year2ApiGateway + year3ApiGateway)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ CloudFront CDN</td>
                    <td class="number currency">${formatCurrency(year1CloudFront)}</td>
                    <td class="number currency">${formatCurrency(year2CloudFront)}</td>
                    <td class="number currency">${formatCurrency(year3CloudFront)}</td>
                    <td class="number currency">${formatCurrency(year1CloudFront + year2CloudFront + year3CloudFront)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ S3 Storage</td>
                    <td class="number currency">${formatCurrency(year1S3)}</td>
                    <td class="number currency">${formatCurrency(year2S3)}</td>
                    <td class="number currency">${formatCurrency(year3S3)}</td>
                    <td class="number currency">${formatCurrency(year1S3 + year2S3 + year3S3)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ CloudWatch Logs</td>
                    <td class="number currency">${formatCurrency(year1CloudWatch)}</td>
                    <td class="number currency">${formatCurrency(year2CloudWatch)}</td>
                    <td class="number currency">${formatCurrency(year3CloudWatch)}</td>
                    <td class="number currency">${formatCurrency(year1CloudWatch + year2CloudWatch + year3CloudWatch)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ EventBridge</td>
                    <td class="number currency">${formatCurrency(year1EventBridge)}</td>
                    <td class="number currency">${formatCurrency(year2EventBridge)}</td>
                    <td class="number currency">${formatCurrency(year3EventBridge)}</td>
                    <td class="number currency">${formatCurrency(year1EventBridge + year2EventBridge + year3EventBridge)}</td>
                </tr>
                <tr>
                    <td>&nbsp;&nbsp;‚Ä¢ SQS Messaging</td>
                    <td class="number currency">${formatCurrency(year1SQS)}</td>
                    <td class="number currency">${formatCurrency(year2SQS)}</td>
                    <td class="number currency">${formatCurrency(year3SQS)}</td>
                    <td class="number currency">${formatCurrency(year1SQS + year2SQS + year3SQS)}</td>
                </tr>
                <tr class="total-row">
                    <td><strong>üí∞ TOTAL COST</strong></td>
                    <td class="number currency"><strong>${formatCurrency(year1Total)}</strong></td>
                    <td class="number currency"><strong>${formatCurrency(year2Total)}</strong></td>
                    <td class="number currency"><strong>${formatCurrency(year3Total)}</strong></td>
                    <td class="number currency"><strong>${formatCurrency(threeYearTotal)}</strong></td>
                </tr>
            `;
        }

        function updateAnalysisTable(threeYearTotal, avgUsers, costPerUser, monthlyCostPerUser, activeUserRate, year1Development, year2Development, year3Development, mvpTotal, year1Hosting, year2Hosting, year3Hosting, year1Licensing, year2Licensing, year3Licensing, year1ThirdParty, year2ThirdParty, year3ThirdParty, annualDevTools, year1AWSTotal, year2AWSTotal, year3AWSTotal, year1GraphDB, year2GraphDB, year3GraphDB, graphDbOption, numOrganizations, organizationGrowth, orgsPerInstance, year3Users, baseMaintenanceMonthly, supportGrowth, numExperts, numEngineers, numFrontendEngineers, apiRequestsPerUser, apiGatewayRequests, lambdaGrowth, mvpDuration, workingDays, expertHours, engineerHours, frontendHours, expertMaintenanceHours, engineerMaintenanceHours, frontendMaintenanceHours) {
            const analysisBody = document.getElementById('analysisBody');
            const avgMonthlyCost = threeYearTotal / 36;
            const developmentPercentage = ((year1Development + year2Development + year3Development) / threeYearTotal * 100).toFixed(1);
            const mvpPercentage = (mvpTotal / threeYearTotal * 100).toFixed(1);
            const infrastructurePercentage = (((year1Hosting + year2Hosting + year3Hosting) + (year1Licensing + year2Licensing + year3Licensing) + (year1ThirdParty + year2ThirdParty + year3ThirdParty) + (annualDevTools * 3)) / threeYearTotal * 100).toFixed(1);
            const awsPercentage = ((year1AWSTotal + year2AWSTotal + year3AWSTotal) / threeYearTotal * 100).toFixed(1);
            const graphDbPercentage = ((year1GraphDB + year2GraphDB + year3GraphDB) / threeYearTotal * 100).toFixed(1);
            
            const year3Orgs = numOrganizations * Math.pow(1 + organizationGrowth, 2);
            const calculateNeo4jInstances = (orgs) => Math.ceil(orgs / orgsPerInstance);
            const year3Instances = graphDbOption === 'paid' ? calculateNeo4jInstances(year3Orgs) : 0;
            
            const totalMvpHours = workingDays * mvpDuration * ((expertHours * numExperts) + (engineerHours * numEngineers) + (frontendHours * numFrontendEngineers)) / 5;
            const totalMaintenanceHours = (expertMaintenanceHours * numExperts) + (engineerMaintenanceHours * numEngineers) + (frontendMaintenanceHours * numFrontendEngineers);
            const year3MaintenanceHours = totalMaintenanceHours * Math.pow(1 + supportGrowth, 2);
            
            const year3AWSPerUser = year3AWSTotal / year3Users / 12;
            const activeUsers = year3Users * activeUserRate;
            const costPerActiveUser = threeYearTotal / activeUsers / 12;

            analysisBody.innerHTML = `
                <tr>
                    <td>Average Monthly Cost</td>
                    <td class="number currency">${formatCurrency(avgMonthlyCost)}</td>
                </tr>
                <tr>
                    <td>3-Year Cost Per User</td>
                    <td class="number currency">${formatCurrencyPrecise(costPerUser)}</td>
                </tr>
                <tr>
                    <td>Monthly Cost Per User</td>
                    <td class="number currency">${formatCurrencyPrecise(monthlyCostPerUser)}</td>
                </tr>
                <tr>
                    <td>Monthly Cost Per Active User (${(activeUserRate * 100).toFixed(0)}% active)</td>
                    <td class="number currency">${formatCurrencyPrecise(costPerActiveUser)}</td>
                </tr>
                <tr>
                    <td>MVP Cost as % of Total</td>
                    <td class="number">${mvpPercentage}%</td>
                </tr>
                <tr>
                    <td>Development Team as % of Total</td>
                    <td class="number">${developmentPercentage}%</td>
                </tr>
                <tr>
                    <td>Infrastructure & Licenses as % of Total</td>
                    <td class="number">${infrastructurePercentage}%</td>
                </tr>
                <tr>
                    <td>AWS Services as % of Total</td>
                    <td class="number">${awsPercentage}%</td>
                </tr>
                <tr>
                    <td>Graph Database as % of Total</td>
                    <td class="number">${graphDbPercentage}%</td>
                </tr>
                <tr>
                    <td>Graph Database Setup</td>
                    <td class="number">${graphDbOption === 'free' ? 'Free Neo4j (Community)' : 'Paid Neo4j (Discovery)'}</td>
                </tr>
                <tr>
                    <td>Year 3 Projected Organizations</td>
                    <td class="number">${Math.round(year3Orgs).toLocaleString()}</td>
                </tr>
                <tr>
                    <td>Year 3 Neo4j Instances Required</td>
                    <td class="number">${year3Instances}</td>
                </tr>
                <tr>
                    <td>Year 3 Projected Users</td>
                    <td class="number">${Math.round(year3Users).toLocaleString()}</td>
                </tr>
                <tr>
                    <td>AWS Cost Per User (Year 3)</td>
                    <td class="number currency">${formatCurrencyPrecise(year3AWSPerUser)}</td>
                </tr>
                <tr>
                    <td>Total MVP Hours (All Resources)</td>
                    <td class="number">${totalMvpHours.toFixed(0)} hours</td>
                </tr>
                <tr>
                    <td>Monthly Maintenance Hours (Base)</td>
                    <td class="number">${totalMaintenanceHours.toFixed(1)} hours</td>
                </tr>
                <tr>
                    <td>Monthly Maintenance Hours (Year 3)</td>
                    <td class="number">${year3MaintenanceHours.toFixed(1)} hours</td>
                </tr>
                <tr>
                    <td>Total Team Size</td>
                    <td class="number">${numExperts + numEngineers + numFrontendEngineers} developers</td>
                </tr>
                <tr>
                    <td>Team Composition</td>
                    <td class="number">${numExperts} Expert(s), ${numEngineers} Engineer(s), ${numFrontendEngineers} Frontend</td>
                </tr>
                <tr>
                    <td>API Requests per Active User/Month</td>
                    <td class="number">${(apiRequestsPerUser / activeUserRate).toFixed(0)} requests</td>
                </tr>
                <tr>
                    <td>Total API Requests (Year 3)</td>
                    <td class="number">${(apiGatewayRequests * 12 * Math.pow(1 + lambdaGrowth, 2)).toFixed(1)}M requests</td>
                </tr>
            `;
        }

        // Auto-switch Neo4j function
        function autoSwitchNeo4jPaid(numOrgs) {
            const neo4jSelect = document.getElementById('graphDbOption');
            if (parseInt(numOrgs, 10) > 4 && neo4jSelect.value !== 'paid') {
                neo4jSelect.value = 'paid';
                calculateTCO();
            } else if (parseInt(numOrgs, 10) <= 4 && neo4jSelect.value !== 'free') {
                neo4jSelect.value = 'free';
                calculateTCO();
            }
        }

        // Initialize everything
        function initializeSliders() {
            updateSliderValue('userGrowthSlider', 'userGrowthValue');
            updateSliderValue('expectedUsersSlider', 'expectedUsersValue', '', true);
            updateSliderValue('organizationGrowthSlider', 'organizationGrowthValue');
            updateSliderValue('numExpertsSlider', 'numExpertsValue');
            updateSliderValue('numEngineersSlider', 'numEngineersValue');
            updateSliderValue('numFrontendEngineersSlider', 'numFrontendEngineersValue');
            updateSliderValue('lambdaRequestsSlider', 'lambdaRequestsValue');
            updateSliderValue('apiGatewayRequestsSlider', 'apiGatewayRequestsValue');
            updateSliderValue('cloudFrontDataSlider', 'cloudFrontDataValue');
            updateSliderValue('expertRateSlider', 'expertRateValue', '', true);
            updateSliderValue('engineerRateSlider', 'engineerRateValue', '', true);
            updateSliderValue('frontendRateSlider', 'frontendRateValue', '', true);
            updateSliderValue('expertHoursSlider', 'expertHoursValue');
            updateSliderValue('engineerHoursSlider', 'engineerHoursValue');
            updateSliderValue('frontendHoursSlider', 'frontendHoursValue');
            updateSliderValue('mvpDurationSlider', 'mvpDurationValue');
            updateSliderValue('expertMaintenanceHoursSlider', 'expertMaintenanceHoursValue');
            updateSliderValue('engineerMaintenanceHoursSlider', 'engineerMaintenanceHoursValue');
            updateSliderValue('frontendMaintenanceHoursSlider', 'frontendMaintenanceHoursValue');
            updateSliderValue('maintenanceRateMultiplierSlider', 'maintenanceRateMultiplierValue');
            updateSliderValue('supportGrowthSlider', 'supportGrowthValue');
            updateSliderValue('numOrganizationsSlider', 'numOrganizationsValue');
            updateSliderValue('orgsPerInstanceSlider', 'orgsPerInstanceValue');
            updateSliderValue('neo4jInstanceCostSlider', 'neo4jInstanceCostValue', '', true);
        }

        // Initialize everything
        initializeSliders();
        calculateTCO();
    </script>
</body>
</html>